<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyAI - Smart Real Estate Analysis</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAFzwS60FzQMJkPBST0jsE47y8ps2b4iYs" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #E76F51;
            --primary-light: #F4A261;
            --primary-dark: #D64933;
            --secondary: #2A9D8F;
            --accent: #264653;
            --bg-light: #FAFAFA;
            --bg-white: #FFFFFF;
            --text-primary: #1A1A2E;
            --text-secondary: #64748B;
            --text-muted: #94A3B8;
            --border: #E2E8F0;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode {
            --bg-light: #0F172A;
            --bg-white: #1E293B;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
            --border: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Animated Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .animated-bg::before {
            content: '';
            position: absolute;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(231, 111, 81, 0.08) 0%, transparent 70%);
            top: -200px;
            right: -200px;
            animation: float 20s ease-in-out infinite;
        }

        .animated-bg::after {
            content: '';
            position: absolute;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(42, 157, 143, 0.06) 0%, transparent 70%);
            bottom: -150px;
            left: -150px;
            animation: float 25s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(30px, -30px) rotate(5deg); }
            50% { transform: translate(-20px, 20px) rotate(-5deg); }
            75% { transform: translate(10px, 40px) rotate(3deg); }
        }

        /* Header */
        .header {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-base), box-shadow var(--transition-base);
        }

        .logo:hover .logo-icon {
            transform: scale(1.05) rotate(-5deg);
            box-shadow: var(--shadow-lg);
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-tagline {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all var(--transition-base);
        }

        .status-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .status-demo {
            background: rgba(231, 111, 81, 0.1);
            color: var(--primary);
        }

        .status-demo::before {
            background: var(--primary);
        }

        .status-connected {
            background: rgba(42, 157, 143, 0.1);
            color: var(--secondary);
        }

        .status-connected::before {
            background: var(--secondary);
        }

        .header-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border: 1px solid var(--border);
            background: var(--bg-white);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
        }

        .header-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(231, 111, 81, 0.05);
            transform: translateY(-1px);
        }

        .theme-toggle {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            background: var(--bg-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all var(--transition-fast);
        }

        .theme-toggle:hover {
            border-color: var(--primary);
            transform: rotate(180deg);
        }

        /* Main Container */
        .container {
            display: flex;
            height: calc(100vh - 73px);
            position: relative;
        }

        /* Map Container */
        #map {
            flex: 1;
            height: 100%;
            position: relative;
        }

        /* Glass Card Base */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
        }

        body.dark-mode .glass-card {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(51, 65, 85, 0.5);
        }

        /* Filter Panel */
        .filter-panel {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 1000;
            width: 340px;
            padding: 1.5rem;
            transition: all var(--transition-slow);
            transform-origin: top left;
        }

        .filter-panel.collapsed {
            padding: 1rem;
            width: auto;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .filter-panel.collapsed .filter-header {
            margin-bottom: 0;
        }

        .filter-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-toggle-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .filter-toggle-btn:hover {
            background: var(--primary);
            color: white;
        }

        .filter-content {
            animation: slideDown var(--transition-base) ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .filter-panel.collapsed .filter-content {
            display: none;
        }

        .filter-section {
            margin-bottom: 1.25rem;
        }

        .filter-section label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.75px;
        }

        .property-type-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .type-filter-btn {
            padding: 0.5rem 0.875rem;
            border: 1px solid var(--border);
            background: var(--bg-white);
            border-radius: 100px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all var(--transition-fast);
            color: var(--text-secondary);
        }

        .type-filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .type-filter-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(231, 111, 81, 0.3);
        }

        .price-range-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .price-input-group {
            position: relative;
        }

        .price-input-group input {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 1.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 500;
            background: var(--bg-white);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .price-input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(231, 111, 81, 0.1);
        }

        .price-input-group .currency {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-weight: 500;
        }

        .filter-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.25rem;
        }

        .btn-primary {
            flex: 1;
            padding: 0.75rem 1.25rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: 0 2px 8px rgba(231, 111, 81, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 111, 81, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            padding: 0.75rem 1rem;
            background: var(--bg-white);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-secondary:hover {
            border-color: var(--text-secondary);
            background: var(--bg-light);
        }

        .filter-results {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
            padding: 0.75rem;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            margin-top: 1rem;
            font-weight: 500;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .map-control-btn {
            padding: 0.75rem 1rem;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .map-control-btn:hover {
            transform: translateY(-2px);
        }

        .map-control-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .map-type-selector {
            padding: 0.5rem;
        }

        .map-type-selector select {
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .map-type-selector select:focus {
            outline: none;
        }

        /* Sidebar */
        .sidebar {
            width: 480px;
            background: var(--bg-white);
            overflow-y: auto;
            box-shadow: -4px 0 24px rgba(0,0,0,0.08);
            display: none;
            position: relative;
            animation: slideInRight var(--transition-slow) ease-out;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .sidebar.active {
            display: block;
        }

        .sidebar-header {
            padding: 2rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .sidebar-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
            position: relative;
        }

        .sidebar-header p {
            opacity: 0.9;
            font-size: 0.9rem;
            font-weight: 500;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            z-index: 1;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .property-image {
            width: 100%;
            height: 240px;
            object-fit: cover;
            transition: transform var(--transition-slow);
        }

        .property-image:hover {
            transform: scale(1.02);
        }

        .section {
            padding: 1.75rem 2rem;
            border-bottom: 1px solid var(--border);
        }

        .section h3 {
            font-size: 1rem;
            margin-bottom: 1.25rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.625rem;
            font-weight: 600;
        }

        .section-icon {
            font-size: 1.25rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.25rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 0.375rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.75px;
        }

        .info-value {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Alert Styles */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.875rem;
            animation: fadeIn var(--transition-base) ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-warning {
            background: linear-gradient(135deg, rgba(244, 162, 97, 0.1) 0%, rgba(231, 111, 81, 0.05) 100%);
            border: 1px solid rgba(244, 162, 97, 0.3);
        }

        .alert-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(42, 157, 143, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 1px solid rgba(42, 157, 143, 0.3);
        }

        .alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert-content h4 {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .alert-content p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Insurance List */
        .insurance-list {
            list-style: none;
        }

        .insurance-list li {
            padding: 0.875rem 1rem;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .insurance-list li:hover {
            background: rgba(42, 157, 143, 0.1);
            transform: translateX(4px);
        }

        .insurance-list li::before {
            content: "‚úì";
            background: var(--secondary);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* Metric Cards */
        .metric-card {
            background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-white) 100%);
            padding: 1.25rem;
            border-radius: var(--radius-md);
            text-align: center;
            border: 1px solid var(--border);
            transition: all var(--transition-fast);
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.375rem;
        }

        .metric-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.75px;
            font-weight: 600;
        }

        /* Map Popup */
        .leaflet-popup-content-wrapper {
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            padding: 0;
            overflow: hidden;
        }

        .leaflet-popup-content {
            margin: 0;
            min-width: 260px;
        }

        .popup-content {
            padding: 1.25rem;
        }

        .popup-content h4 {
            margin-bottom: 0.25rem;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
        }

        .popup-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .popup-price {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0.75rem 0;
        }

        .view-details-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            font-size: 0.875rem;
            margin-top: 0.75rem;
            transition: all var(--transition-fast);
            box-shadow: 0 2px 8px rgba(231, 111, 81, 0.3);
        }

        .view-details-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 111, 81, 0.4);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn var(--transition-base) ease-out;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-white);
            border-radius: var(--radius-xl);
            padding: 2rem;
            max-width: 640px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideUp var(--transition-slow) ease-out;
            box-shadow: var(--shadow-xl);
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(50px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.75rem;
        }

        .modal-header h2 {
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            background: var(--bg-light);
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--primary);
            color: white;
            transform: rotate(90deg);
        }

        .api-option {
            padding: 1.5rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .api-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(231, 111, 81, 0.05) 0%, transparent 100%);
            opacity: 0;
            transition: opacity var(--transition-fast);
            pointer-events: none;
        }

        .api-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .api-option:hover::before {
            opacity: 1;
        }

        .api-option h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .api-option p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .api-option .btn-primary {
            position: relative;
            z-index: 1;
        }

        .input-group {
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .input-group label {
            display: block;
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            background: var(--bg-white);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(231, 111, 81, 0.1);
        }

        .info-banner {
            margin-top: 1.5rem;
            padding: 1.25rem;
            background: linear-gradient(135deg, rgba(42, 157, 143, 0.1) 0%, rgba(38, 70, 83, 0.05) 100%);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(42, 157, 143, 0.2);
        }

        .info-banner p {
            font-size: 0.85rem;
            color: var(--secondary);
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .info-banner ol {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-left: 1.25rem;
            line-height: 1.8;
        }

        .info-banner code {
            background: var(--bg-white);
            padding: 0.125rem 0.5rem;
            border-radius: var(--radius-sm);
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 0.75rem;
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: toastIn var(--transition-base) ease-out;
            box-shadow: var(--shadow-lg);
            min-width: 300px;
            max-width: 450px;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .toast.toast-out {
            animation: toastOut var(--transition-base) ease-in forwards;
        }

        @keyframes toastOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }

        .toast-success {
            background: linear-gradient(135deg, var(--secondary) 0%, #1D7A70 100%);
            color: white;
        }

        .toast-error {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
        }

        .toast-info {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.125rem;
        }

        .toast-message {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .toast-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2500;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1.5rem;
        }

        body.dark-mode .loading-overlay {
            background: rgba(15, 23, 42, 0.9);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 56px;
            height: 56px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 100%;
                height: 100%;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 1500;
            }

            .filter-panel {
                width: calc(100% - 3rem);
                max-width: 340px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0.875rem 1rem;
            }

            .logo-text {
                font-size: 1.25rem;
            }

            .logo-tagline {
                display: none;
            }

            .header-btn span:not(.btn-icon) {
                display: none;
            }

            .container {
                flex-direction: column;
            }

            #map {
                height: 100%;
            }

            .filter-panel {
                top: 1rem;
                left: 1rem;
                width: calc(100% - 2rem);
                max-width: none;
            }

            .map-controls {
                top: 1rem;
                right: 1rem;
            }

            .toast-container {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
            }

            .toast {
                min-width: auto;
                max-width: none;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 0.5rem;
            margin-right: 1.5rem;
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-btn:hover {
            background: var(--bg-light);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(231, 111, 81, 0.3);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            height: 100%;
        }

        .tab-content.active {
            display: flex;
        }

        /* Address Analysis Page */
        .analysis-page {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: var(--bg-light);
        }

        .analysis-header {
            max-width: 900px;
            margin: 0 auto 2rem;
            text-align: center;
        }

        .analysis-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .analysis-header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .address-input-section {
            max-width: 700px;
            margin: 0 auto 2.5rem;
        }

        .address-input-wrapper {
            display: flex;
            gap: 1rem;
            background: var(--bg-white);
            padding: 0.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .address-input-wrapper input {
            flex: 1;
            padding: 1rem 1.25rem;
            border: none;
            background: transparent;
            font-size: 1rem;
            color: var(--text-primary);
            outline: none;
            position: relative;
            z-index: 10;
        }

        .address-input-wrapper input:focus {
            background: rgba(231, 111, 81, 0.05);
            border-radius: var(--radius-md);
        }

        .address-input-wrapper input::placeholder {
            color: var(--text-muted);
        }

        .address-input-wrapper .btn-primary {
            padding: 1rem 2rem;
            white-space: nowrap;
        }

        .analysis-functions {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .function-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 1.75rem;
            border: 1px solid var(--border);
            transition: all var(--transition-fast);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .function-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            transform: scaleX(0);
            transition: transform var(--transition-fast);
        }

        .function-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .function-card:hover::before {
            transform: scaleX(1);
        }

        .function-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .function-card.disabled:hover {
            transform: none;
            box-shadow: none;
            border-color: var(--border);
        }

        .function-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, rgba(231, 111, 81, 0.1) 0%, rgba(244, 162, 97, 0.1) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin-bottom: 1rem;
        }

        .function-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .function-card p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .function-status {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.375rem 0.75rem;
            border-radius: 100px;
        }

        .function-status.ready {
            background: rgba(42, 157, 143, 0.1);
            color: var(--secondary);
        }

        .function-status.coming-soon {
            background: rgba(100, 116, 139, 0.1);
            color: var(--text-muted);
        }

        .analysis-results {
            max-width: 900px;
            margin: 2rem auto 0;
            display: none;
        }

        .analysis-results.active {
            display: block;
        }

        .results-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 1.75rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .results-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .results-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .results-close:hover {
            background: var(--primary);
            color: white;
        }

        .results-content {
            color: var(--text-primary);
        }

        /* Google Places Autocomplete Styling */
        .pac-container {
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            font-family: 'Inter', sans-serif;
            margin-top: 4px;
        }

        .pac-item {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .pac-item:hover {
            background: var(--bg-light);
        }

        .pac-item-query {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Saved Destinations */
        .saved-destinations {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .saved-destinations h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .destination-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .destination-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-light);
            padding: 0.875rem 1rem;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }

        .destination-item:hover {
            background: rgba(231, 111, 81, 0.1);
        }

        .destination-info {
            flex: 1;
            min-width: 0;
        }

        .destination-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
            margin-bottom: 0.125rem;
        }

        .destination-address {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .destination-time {
            font-weight: 700;
            color: var(--primary);
            font-size: 1rem;
            margin: 0 1rem;
            white-space: nowrap;
        }

        .destination-delete {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .destination-delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
        }

        .add-destination-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .add-destination-form input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--bg-white);
            color: var(--text-primary);
        }

        .add-destination-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .add-destination-form .btn-add {
            padding: 0.75rem 1rem;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-fast);
        }

        .add-destination-form .btn-add:hover {
            background: #1D7A70;
        }

        .empty-destinations {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading properties...</div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Header -->
    <div class="header">
        <div class="logo">
            <div class="logo-icon">üè†</div>
            <div>
                <div class="logo-text">PropertyAI</div>
                <div class="logo-tagline">Smart Real Estate Analysis</div>
            </div>
        </div>
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('map')" id="tabMap">
                üó∫Ô∏è Property Map
            </button>
            <button class="tab-btn" onclick="switchTab('analysis')" id="tabAnalysis">
                üìä Address Analysis
            </button>
        </div>
        <div class="header-controls">
            <span class="status-badge status-demo" id="dataStatus">Demo Mode</span>
            <button class="header-btn" onclick="openSettings()">
                <span class="btn-icon">‚öôÔ∏è</span>
                <span>Data Source</span>
            </button>
            <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Toggle theme">üåô</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Tab 1: Property Map -->
        <div class="tab-content active" id="mapTab">
        <div id="map">
            <!-- Filter Panel -->
            <div class="filter-panel glass-card" id="filterPanel">
                <div class="filter-header">
                    <h3>üîç Filters</h3>
                    <button class="filter-toggle-btn" onclick="toggleFilterPanel()" title="Toggle filters">‚àí</button>
                </div>
                <div class="filter-content">
                    <div class="filter-section">
                        <label>Property Type</label>
                        <div class="property-type-filters">
                            <button class="type-filter-btn active" data-type="Single Family" onclick="togglePropertyType(this, 'Single Family')">
                                üè† House
                            </button>
                            <button class="type-filter-btn active" data-type="Townhouse" onclick="togglePropertyType(this, 'Townhouse')">
                                üèòÔ∏è Townhome
                            </button>
                            <button class="type-filter-btn active" data-type="Condo" onclick="togglePropertyType(this, 'Condo')">
                                üè¢ Condo
                            </button>
                        </div>
                    </div>

                    <div class="filter-section">
                        <label>Price Range</label>
                        <div class="price-range-inputs">
                            <div class="price-input-group">
                                <span class="currency">$</span>
                                <input type="number" id="minPrice" placeholder="Min" step="50000">
                            </div>
                            <div class="price-input-group">
                                <span class="currency">$</span>
                                <input type="number" id="maxPrice" placeholder="Max" step="50000">
                            </div>
                        </div>
                    </div>

                    <div class="filter-actions">
                        <button class="btn-primary" onclick="applyFilters()">Apply Filters</button>
                        <button class="btn-secondary" onclick="resetFilters()">Reset</button>
                    </div>

                    <div class="filter-results" id="filterResults">
                        Showing all properties
                    </div>
                </div>
            </div>

            <!-- Map Controls -->
            <div class="map-controls">
                <div class="map-type-selector glass-card">
                    <select id="mapTypeSelector" onchange="changeMapType(this.value)">
                        <option value="standard">üó∫Ô∏è Standard</option>
                        <option value="satellite">üõ∞Ô∏è Satellite</option>
                        <option value="hybrid">üåç Hybrid</option>
                        <option value="terrain">‚õ∞Ô∏è Terrain</option>
                    </select>
                </div>
                <button class="map-control-btn glass-card" onclick="zoomToAllProperties()" title="Show all properties">
                    üéØ Fit All
                </button>
                <button class="map-control-btn glass-card" onclick="toggleHeatmap()" id="heatmapBtn" title="Show price heatmap">
                    üî• Heatmap
                </button>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <button class="close-btn" onclick="closeSidebar()" title="Close panel">√ó</button>
            <div id="sidebarContent"></div>
        </div>
        </div>

        <!-- Tab 2: Address Analysis -->
        <div class="tab-content" id="analysisTab">
            <div class="analysis-page">
                <div class="analysis-header">
                    <h1>Address Analysis</h1>
                    <p>Enter a property address to get detailed insights and analysis</p>
                </div>

                <div class="address-input-section">
                    <div class="address-input-wrapper">
                        <input type="text" id="analysisAddress" placeholder="Enter full address (e.g., 123 Main St, Miami, FL 33101)">
                        <button class="btn-primary" onclick="analyzeAddress()">Analyze</button>
                    </div>
                </div>

                <div class="analysis-functions">
                    <div class="function-card" onclick="runAnalysis('commute')">
                        <div class="function-icon">üöó</div>
                        <h3>Commute Analysis</h3>
                        <p>Calculate commute times to work, schools, and popular destinations. Get traffic insights and transportation options.</p>
                        <span class="function-status ready">‚óè Ready</span>
                    </div>

                    <div class="function-card" onclick="runAnalysis('fema')">
                        <div class="function-icon">üåä</div>
                        <h3>FEMA Flood Records</h3>
                        <p>Check flood zone designation, historical flood data, and insurance requirements from FEMA databases.</p>
                        <span class="function-status ready">‚óè Ready</span>
                    </div>

                    <div class="function-card" onclick="runAnalysis('schools')">
                        <div class="function-icon">üéì</div>
                        <h3>School Records</h3>
                        <p>Find nearby schools with ratings, test scores, student-teacher ratios, and district information.</p>
                        <span class="function-status ready">‚óè Ready</span>
                    </div>

                    <div class="function-card disabled" onclick="showComingSoon()">
                        <div class="function-icon">üè™</div>
                        <h3>Nearby Amenities</h3>
                        <p>Discover grocery stores, restaurants, parks, hospitals, and other amenities within walking distance.</p>
                        <span class="function-status coming-soon">‚óã Coming Soon</span>
                    </div>

                    <div class="function-card disabled" onclick="showComingSoon()">
                        <div class="function-icon">üìà</div>
                        <h3>Market Trends</h3>
                        <p>View historical price trends, appreciation rates, and market forecasts for the neighborhood.</p>
                        <span class="function-status coming-soon">‚óã Coming Soon</span>
                    </div>

                    <div class="function-card disabled" onclick="showComingSoon()">
                        <div class="function-icon">üîí</div>
                        <h3>Crime Statistics</h3>
                        <p>Access crime data, safety scores, and neighborhood watch information for the area.</p>
                        <span class="function-status coming-soon">‚óã Coming Soon</span>
                    </div>
                </div>

                <div class="analysis-results" id="analysisResults">
                    <div class="results-card">
                        <div class="results-header">
                            <h2 id="resultsTitle">Analysis Results</h2>
                            <button class="results-close" onclick="closeResults()">√ó</button>
                        </div>
                        <div class="results-content" id="resultsContent">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Configure Data Source</h2>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>

            <div class="api-option">
                <h3>üè¢ Zillow API</h3>
                <p>Access comprehensive MLS listings via Zillow's API through RapidAPI.</p>
                <div class="input-group">
                    <label>RapidAPI Key</label>
                    <input type="text" id="zillowApiKey" placeholder="Enter your RapidAPI key">
                </div>
                <div class="input-group">
                    <label>Location</label>
                    <input type="text" id="zillowLocation" placeholder="e.g., Miami, FL or 33101">
                </div>
                <button class="btn-primary" onclick="connectZillow()">Connect Zillow</button>
            </div>

            <div class="api-option">
                <h3>üèòÔ∏è Realty in US API</h3>
                <p>Real-time US real estate listings. Start the backend server to use.</p>
                <div class="input-group">
                    <label>ZIP Code</label>
                    <input type="text" id="postalCode" placeholder="e.g., 90004" value="90004">
                </div>
                <div class="input-group">
                    <label>Number of Listings</label>
                    <input type="number" id="listingLimit" placeholder="50" value="50" min="1" max="200">
                </div>
                <button class="btn-primary" onclick="connectRealtyInUS()">Load Listings</button>
            </div>

            <div class="api-option">
                <h3>üåê Custom API</h3>
                <p>Connect to your own MLS data provider or custom endpoint.</p>
                <div class="input-group">
                    <label>API Endpoint</label>
                    <input type="text" id="customEndpoint" placeholder="https://api.example.com/listings">
                </div>
                <div class="input-group">
                    <label>API Key (Optional)</label>
                    <input type="text" id="customApiKey" placeholder="Your API key">
                </div>
                <button class="btn-primary" onclick="connectCustom()">Connect</button>
            </div>

            <div class="api-option">
                <h3>üìä Demo Mode</h3>
                <p>Use sample data for demonstration. No API connection required.</p>
                <button class="btn-primary" onclick="useDemo()">Continue with Demo</button>
            </div>

            <div class="info-banner">
                <p>üí° How to Get Real Listings:</p>
                <ol>
                    <li>Download all files (HTML + server.js + package.json)</li>
                    <li>Run: <code>npm install</code></li>
                    <li>Start: <code>npm start</code></li>
                    <li>Open: <code>http://localhost:3000</code></li>
                    <li>Enter ZIP code and load listings!</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // 1. CONSTANTS & DATA FIRST
        // ============================================

        // Sample property data (demo)
        const demoProperties = [
            {
                id: 1,
                address: "123 Ocean View Dr",
                city: "Miami Beach, FL",
                price: 875000,
                beds: 3,
                baths: 2.5,
                sqft: 2100,
                lat: 25.7907,
                lng: -80.1300,
                femaZone: "AE",
                floodRisk: "High",
                yearBuilt: 2015,
                lotSize: "0.25 acres",
                propertyType: "Single Family",
                image: "https://images.unsplash.com/photo-1613490493576-7fde63acd811?w=800"
            },
            {
                id: 2,
                address: "456 Lakeside Ave",
                city: "Orlando, FL",
                price: 425000,
                beds: 4,
                baths: 3,
                sqft: 2400,
                lat: 28.5383,
                lng: -81.3792,
                femaZone: "X",
                floodRisk: "Low",
                yearBuilt: 2018,
                lotSize: "0.30 acres",
                propertyType: "Single Family",
                image: "https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?w=800"
            },
            {
                id: 3,
                address: "789 Coastal Blvd",
                city: "Tampa, FL",
                price: 650000,
                beds: 3,
                baths: 2,
                sqft: 1950,
                lat: 27.9506,
                lng: -82.4572,
                femaZone: "VE",
                floodRisk: "Very High",
                yearBuilt: 2010,
                lotSize: "0.20 acres",
                propertyType: "Townhouse",
                image: "https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=800"
            },
            {
                id: 4,
                address: "321 Highland Terrace",
                city: "Jacksonville, FL",
                price: 385000,
                beds: 3,
                baths: 2,
                sqft: 1800,
                lat: 30.3322,
                lng: -81.6557,
                femaZone: "X",
                floodRisk: "Low",
                yearBuilt: 2020,
                lotSize: "0.18 acres",
                propertyType: "Single Family",
                image: "https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=800"
            },
            {
                id: 5,
                address: "555 Bayfront Circle",
                city: "Fort Lauderdale, FL",
                price: 1200000,
                beds: 4,
                baths: 3.5,
                sqft: 3200,
                lat: 26.1224,
                lng: -80.1373,
                femaZone: "AE",
                floodRisk: "High",
                yearBuilt: 2019,
                lotSize: "0.35 acres",
                propertyType: "Single Family",
                image: "https://images.unsplash.com/photo-1580587771525-78b9dba3b914?w=800"
            },
            {
                id: 6,
                address: "888 Downtown Plaza #1502",
                city: "Miami, FL",
                price: 525000,
                beds: 2,
                baths: 2,
                sqft: 1200,
                lat: 25.7617,
                lng: -80.1918,
                femaZone: "X",
                floodRisk: "Low",
                yearBuilt: 2021,
                lotSize: "N/A",
                propertyType: "Condo",
                image: "https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=800"
            },
            {
                id: 7,
                address: "234 Sunset Row",
                city: "Naples, FL",
                price: 475000,
                beds: 3,
                baths: 2.5,
                sqft: 1850,
                lat: 26.1420,
                lng: -81.7948,
                femaZone: "X",
                floodRisk: "Low",
                yearBuilt: 2019,
                lotSize: "0.08 acres",
                propertyType: "Townhouse",
                image: "https://images.unsplash.com/photo-1572120360610-d971b9d7767c?w=800"
            },
            {
                id: 8,
                address: "1010 Harbor View #305",
                city: "Tampa, FL",
                price: 295000,
                beds: 1,
                baths: 1,
                sqft: 850,
                lat: 27.9475,
                lng: -82.4584,
                femaZone: "X",
                floodRisk: "Low",
                yearBuilt: 2017,
                lotSize: "N/A",
                propertyType: "Condo",
                image: "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=800"
            }
        ];

        // ============================================
        // 2. STATE VARIABLES
        // ============================================

        // Active properties array
        const properties = [...demoProperties];
        let allMarkers = [];
        let activePropertyTypes = ['Single Family', 'Townhouse', 'Condo'];
        let heatmapVisible = false;
        let heatmapLayer = null;

        // ============================================
        // 3. MAP INITIALIZATION
        // ============================================

        // Initialize map
        const map = L.map('map').setView([27.9944, -81.7603], 7);

        // Define tile layers
        const tileLayers = {
            standard: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri',
                maxZoom: 19
            }),
            hybrid: L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19
                }),
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}.png', {
                    maxZoom: 19
                })
            ]),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenTopoMap',
                maxZoom: 17
            })
        };

        let currentLayer = tileLayers.standard;
        currentLayer.addTo(map);

        // Custom marker icon
        const propertyIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: linear-gradient(135deg, #E76F51 0%, #F4A261 100%); width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; box-shadow: 0 4px 12px rgba(231, 111, 81, 0.4);"></div>',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
        });

        // ============================================
        // 4. ALL FUNCTION DEFINITIONS
        // ============================================

        // Toast Notification System
        function showToast(type, title, message, duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: '‚úì',
                error: '‚úï',
                info: '‚Ñπ'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="closeToast(this.parentElement)">√ó</button>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                closeToast(toast);
            }, duration);
        }

        function closeToast(toast) {
            toast.classList.add('toast-out');
            setTimeout(() => {
                toast.remove();
            }, 250);
        }

        // Loading Overlay
        function showLoading(text = 'Loading properties...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Normalize property type from API to match filter values
        function normalizePropertyType(type) {
            if (!type) return 'Single Family';

            const normalized = type.toLowerCase().replace(/[_-]/g, ' ').trim();

            if (normalized.includes('single') || normalized.includes('house') || normalized.includes('detached')) {
                return 'Single Family';
            }
            if (normalized.includes('town') || normalized.includes('row')) {
                return 'Townhouse';
            }
            if (normalized.includes('condo') || normalized.includes('apartment') || normalized.includes('flat') || normalized.includes('unit')) {
                return 'Condo';
            }
            if (normalized.includes('multi') || normalized.includes('duplex') || normalized.includes('triplex')) {
                return 'Single Family'; // Group multi-family with single family for now
            }

            return 'Single Family'; // Default
        }

        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');

            body.classList.toggle('dark-mode');

            if (body.classList.contains('dark-mode')) {
                themeToggle.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            } else {
                themeToggle.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            }
        }

        // Settings modal functions
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function updateDataStatus(status, isConnected = false) {
            const statusBadge = document.getElementById('dataStatus');
            statusBadge.textContent = status;
            statusBadge.className = 'status-badge ' + (isConnected ? 'status-connected' : 'status-demo');
        }

        // Add property marker to map
        function addPropertyMarker(property) {
            const marker = L.marker([property.lat, property.lng], { icon: propertyIcon });

            const popupContent = `
                <div class="popup-content">
                    <h4>${property.address}</h4>
                    <p>${property.city}</p>
                    <div class="popup-price">$${property.price.toLocaleString()}</div>
                    <p>${property.beds} beds ‚Ä¢ ${property.baths} baths ‚Ä¢ ${property.sqft.toLocaleString()} sqft</p>
                    <p style="font-size: 0.75rem; color: var(--primary); font-weight: 600; margin-top: 0.25rem;">${property.propertyType}</p>
                    <button class="view-details-btn" onclick="showPropertyDetails(${property.id})">View Analysis</button>
                </div>
            `;

            marker.bindPopup(popupContent);
            marker.addTo(map);

            allMarkers.push({
                property: property,
                marker: marker
            });
        }

        // Load demo properties
        function loadDemoProperties() {
            allMarkers.forEach(markerData => {
                map.removeLayer(markerData.marker);
            });
            allMarkers = [];
            properties.length = 0;

            demoProperties.forEach(property => {
                properties.push({...property});
                addPropertyMarker(property);
            });

            document.getElementById('filterResults').textContent = `Showing all ${allMarkers.length} properties`;
        }

        // Connect to Zillow API
        async function connectZillow() {
            const apiKey = document.getElementById('zillowApiKey').value;
            const location = document.getElementById('zillowLocation').value;

            if (!apiKey || !location) {
                showToast('error', 'Missing Information', 'Please enter both API key and location');
                return;
            }

            try {
                showLoading('Connecting to Zillow...');

                const response = await fetch('https://zillow-com1.p.rapidapi.com/propertyExtendedSearch?location=' + encodeURIComponent(location), {
                    method: 'GET',
                    headers: {
                        'X-RapidAPI-Key': apiKey,
                        'X-RapidAPI-Host': 'zillow-com1.p.rapidapi.com'
                    }
                });

                if (!response.ok) {
                    throw new Error('API connection failed');
                }

                const data = await response.json();

                localStorage.setItem('dataSource', 'Zillow');
                localStorage.setItem('zillowApiKey', apiKey);
                localStorage.setItem('zillowLocation', location);

                if (data.props && data.props.length > 0) {
                    processZillowData(data.props);
                    updateDataStatus('Zillow', true);
                    closeSettings();
                    hideLoading();
                    showToast('success', 'Connected to Zillow', `Found ${data.props.length} properties`);
                } else {
                    hideLoading();
                    showToast('info', 'No Properties Found', 'Connected but no properties found for this location');
                }

            } catch (error) {
                console.error('Zillow API error:', error);
                hideLoading();
                updateDataStatus('Demo Mode', false);
                showToast('error', 'Connection Failed', 'Please check your API key and try again');
            }
        }

        // Connect to Realty in US API
        async function connectRealtyInUS() {
            const postalCode = document.getElementById('postalCode').value;
            const limit = parseInt(document.getElementById('listingLimit').value) || 50;

            if (!postalCode) {
                showToast('error', 'Missing ZIP Code', 'Please enter a ZIP code');
                return;
            }

            try {
                showLoading('Loading listings for ZIP ' + postalCode + '...');

                const apiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'http://localhost:3000/api/properties'
                    : '/api/properties';

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        postal_code: postalCode,
                        limit: limit
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'API request failed');
                }

                localStorage.setItem('dataSource', 'Realty in US');
                localStorage.setItem('postalCode', postalCode);

                let results = null;
                if (data.data && data.data.home_search && data.data.home_search.results) {
                    results = data.data.home_search.results;
                } else if (data.data && data.data.results) {
                    results = data.data.results;
                } else if (data.results) {
                    results = data.results;
                } else if (Array.isArray(data.data)) {
                    results = data.data;
                }

                if (results && results.length > 0) {
                    // Filter out pending properties - only show active for sale listings
                    const forSaleResults = results.filter(prop => {
                        const status = (prop.status || '').toLowerCase();
                        // Exclude pending, under contract, sold, etc.
                        return status === 'for_sale' || status === 'active' || status === '';
                    });

                    if (forSaleResults.length > 0) {
                        processRealtyInUSData(forSaleResults);
                        updateDataStatus(forSaleResults.length + ' For Sale', true);
                        closeSettings();
                        hideLoading();
                        showToast('success', 'Listings Loaded', `Found ${forSaleResults.length} properties for sale in ZIP ${postalCode}`);
                    } else {
                        hideLoading();
                        updateDataStatus('Demo Mode', false);
                        showToast('info', 'No Active Listings', `All ${results.length} properties in ZIP ${postalCode} are pending/sold. Using demo data.`);
                        loadDemoProperties();
                    }
                } else {
                    hideLoading();
                    updateDataStatus('Demo Mode', false);
                    showToast('info', 'No Properties', `No listings found for ZIP ${postalCode}. Using demo data.`);
                    loadDemoProperties();
                }

            } catch (error) {
                console.error('API error:', error);
                hideLoading();
                updateDataStatus('Demo Mode', false);

                if (error.message.includes('Failed to fetch')) {
                    showToast('error', 'Server Not Running', 'Start the backend server with npm start to load real listings');
                } else {
                    showToast('error', 'Error Loading', error.message);
                }

                loadDemoProperties();
            }
        }

        // Process Realty in US data
        function processRealtyInUSData(results) {
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            properties.length = 0;
            allMarkers = [];

            results.forEach((prop, index) => {
                try {
                    let coord = null;
                    let address = null;

                    if (prop.location && prop.location.address) {
                        address = prop.location.address;
                        coord = address.coordinate || address.coord;
                    } else if (prop.address) {
                        address = prop.address;
                        coord = address.coordinate || address.coord;
                    }

                    if (!coord && prop.lat && prop.lon) {
                        coord = { lat: prop.lat, lon: prop.lon };
                    }
                    if (!coord && prop.latitude && prop.longitude) {
                        coord = { lat: prop.latitude, lon: prop.longitude };
                    }

                    if (coord && (coord.lat || coord.latitude) && (coord.lon || coord.longitude)) {
                        let femaZone = 'X';
                        let floodRisk = 'Low';

                        const city = address?.city || '';
                        if (city &&
                            (city.toLowerCase().includes('beach') ||
                             city.toLowerCase().includes('miami') ||
                             city.toLowerCase().includes('tampa'))) {
                            femaZone = 'AE';
                            floodRisk = 'High';
                        }

                        const property = {
                            id: index + 1,
                            address: address?.line || address?.street || prop.full_address || 'Address not available',
                            city: (address?.city || '') + (address?.state_code ? ', ' + address.state_code : ''),
                            price: prop.list_price || prop.price || 0,
                            beds: prop.description?.beds || prop.beds || prop.bedrooms || 0,
                            baths: prop.description?.baths || prop.baths || prop.bathrooms || 0,
                            sqft: prop.description?.sqft || prop.sqft || prop.square_feet || prop.living_area || 0,
                            lat: coord.lat || coord.latitude,
                            lng: coord.lon || coord.longitude,
                            femaZone: femaZone,
                            floodRisk: floodRisk,
                            yearBuilt: prop.description?.year_built || prop.year_built || 2020,
                            lotSize: ((prop.description?.lot_sqft || prop.lot_sqft || prop.lot_size || 0) + ' sqft'),
                            propertyType: normalizePropertyType(prop.description?.type || prop.property_type || prop.type),
                            image: prop.primary_photo?.href || prop.photo?.href || (prop.photos && prop.photos[0]?.href) || 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=800'
                        };

                        properties.push(property);
                        addPropertyMarker(property);
                    }
                } catch (err) {
                    console.error('Error processing property:', err);
                }
            });

            if (properties.length > 0) {
                map.setView([properties[0].lat, properties[0].lng], 13);
                document.getElementById('filterResults').textContent = `Showing all ${properties.length} properties`;
            }
        }

        // Connect to custom API
        async function connectCustom() {
            const endpoint = document.getElementById('customEndpoint').value;
            const apiKey = document.getElementById('customApiKey').value;

            if (!endpoint) {
                showToast('error', 'Missing Endpoint', 'Please enter API endpoint URL');
                return;
            }

            try {
                showLoading('Connecting to API...');

                const headers = {
                    'Content-Type': 'application/json'
                };

                if (apiKey) {
                    headers['Authorization'] = 'Bearer ' + apiKey;
                }

                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error('API connection failed');
                }

                localStorage.setItem('dataSource', 'Custom API');
                localStorage.setItem('customEndpoint', endpoint);
                if (apiKey) localStorage.setItem('customApiKey', apiKey);

                hideLoading();
                updateDataStatus('Custom API', true);
                closeSettings();
                showToast('success', 'Connected', 'Successfully connected to custom API');

            } catch (error) {
                console.error('Custom API error:', error);
                hideLoading();
                updateDataStatus('Demo Mode', false);
                showToast('error', 'Connection Failed', 'Please check your endpoint and credentials');
            }
        }

        // Use demo mode
        function useDemo() {
            localStorage.setItem('dataSource', 'demo');
            updateDataStatus('Demo Mode', false);
            closeSettings();
            loadDemoProperties();
            showToast('info', 'Demo Mode', 'Using sample property data');
        }

        // Process Zillow data
        function processZillowData(props) {
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            properties.length = 0;
            allMarkers = [];

            props.forEach((prop, index) => {
                if (prop.latitude && prop.longitude) {
                    const property = {
                        id: index + 1,
                        address: prop.address || 'Address not available',
                        city: (prop.city || '') + ', ' + (prop.state || ''),
                        price: prop.price || 0,
                        beds: prop.bedrooms || 0,
                        baths: prop.bathrooms || 0,
                        sqft: prop.livingArea || 0,
                        lat: prop.latitude,
                        lng: prop.longitude,
                        femaZone: 'X',
                        floodRisk: 'Low',
                        yearBuilt: prop.yearBuilt || 2020,
                        lotSize: (prop.lotSize || 0) + ' sqft',
                        propertyType: prop.propertyType || 'Single Family',
                        image: prop.imgSrc || 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=800'
                    };

                    properties.push(property);
                    addPropertyMarker(property);
                }
            });

            if (properties.length > 0) {
                map.setView([properties[0].lat, properties[0].lng], 12);
            }
        }

        function changeMapType(type) {
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }
            currentLayer = tileLayers[type];
            currentLayer.addTo(map);
        }

        function zoomToAllProperties() {
            if (properties.length === 0) return;
            const bounds = L.latLngBounds(properties.map(p => [p.lat, p.lng]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        function toggleHeatmap() {
            const btn = document.getElementById('heatmapBtn');

            if (!heatmapVisible) {
                const maxPrice = Math.max(...properties.map(p => p.price));

                heatmapLayer = L.layerGroup();

                properties.forEach(property => {
                    const radius = (property.price / maxPrice) * 100 + 20;
                    const circle = L.circle([property.lat, property.lng], {
                        radius: radius,
                        color: '#E76F51',
                        fillColor: '#F4A261',
                        fillOpacity: 0.3,
                        weight: 2
                    });
                    circle.addTo(heatmapLayer);
                });

                heatmapLayer.addTo(map);
                btn.classList.add('active');
                btn.innerHTML = 'üî• Hide';
                heatmapVisible = true;
            } else {
                if (heatmapLayer) {
                    map.removeLayer(heatmapLayer);
                }
                btn.classList.remove('active');
                btn.innerHTML = 'üî• Heatmap';
                heatmapVisible = false;
            }
        }

        function showPropertyDetails(propertyId) {
            const property = properties.find(p => p.id === propertyId);
            if (!property) return;

            const sidebar = document.getElementById('sidebar');
            const sidebarContent = document.getElementById('sidebarContent');

            const pricePerSqft = Math.round(property.price / property.sqft);
            const estimatedRent = Math.round(property.price * 0.006);
            const capRate = ((estimatedRent * 12) / property.price * 100).toFixed(2);

            let insurances = ['Homeowners Insurance'];
            let alerts = [];

            if (property.femaZone === 'AE' || property.femaZone === 'VE') {
                insurances.push('Flood Insurance (Required)');
                alerts.push({
                    type: property.femaZone === 'VE' ? 'danger' : 'warning',
                    icon: '‚ö†Ô∏è',
                    title: property.femaZone === 'VE' ? 'High Velocity Flood Zone' : 'Special Flood Hazard Area',
                    message: property.femaZone === 'VE'
                        ? 'This property is in a coastal high-hazard area. Flood insurance is mandatory.'
                        : 'This property is in a flood zone. Flood insurance is required for mortgages.'
                });
            } else {
                alerts.push({
                    type: 'success',
                    icon: '‚úì',
                    title: 'Minimal Flood Risk',
                    message: 'Outside high-risk flood zones. Flood insurance is still recommended.'
                });
            }

            insurances.push('Hazard Insurance');
            insurances.push('Liability Insurance');

            if (property.city.includes('FL')) {
                insurances.push('Hurricane/Windstorm Insurance');
            }

            const content = `
                <div class="sidebar-header">
                    <h2>${property.address}</h2>
                    <p>${property.city}</p>
                </div>

                <img src="${property.image}" alt="${property.address}" class="property-image">

                <div class="section">
                    <h3><span class="section-icon">üí∞</span> Property Details</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Price</div>
                            <div class="info-value">$${property.price.toLocaleString()}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Price/Sqft</div>
                            <div class="info-value">$${pricePerSqft}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Bedrooms</div>
                            <div class="info-value">${property.beds}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Bathrooms</div>
                            <div class="info-value">${property.baths}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Square Feet</div>
                            <div class="info-value">${property.sqft.toLocaleString()}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Lot Size</div>
                            <div class="info-value">${property.lotSize}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Year Built</div>
                            <div class="info-value">${property.yearBuilt}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Type</div>
                            <div class="info-value">${property.propertyType}</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3><span class="section-icon">üåä</span> FEMA Flood Analysis</h3>
                    ${alerts.map(alert => `
                        <div class="alert alert-${alert.type}">
                            <div class="alert-icon">${alert.icon}</div>
                            <div class="alert-content">
                                <h4>${alert.title}</h4>
                                <p>${alert.message}</p>
                            </div>
                        </div>
                    `).join('')}
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">FEMA Zone</div>
                            <div class="info-value">${property.femaZone}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Flood Risk</div>
                            <div class="info-value">${property.floodRisk}</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3><span class="section-icon">üõ°Ô∏è</span> Required Insurance</h3>
                    <ul class="insurance-list">
                        ${insurances.map(insurance => `<li>${insurance}</li>`).join('')}
                    </ul>
                </div>

                <div class="section">
                    <h3><span class="section-icon">üìä</span> Investment Metrics</h3>
                    <div class="info-grid">
                        <div class="metric-card">
                            <div class="metric-value">${capRate}%</div>
                            <div class="metric-label">Est. Cap Rate</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">$${estimatedRent.toLocaleString()}</div>
                            <div class="metric-label">Est. Monthly Rent</div>
                        </div>
                    </div>
                </div>
            `;

            sidebarContent.innerHTML = content;
            sidebar.classList.add('active');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
        }

        window.showPropertyDetails = function(propertyId) {
            map.closePopup();
            showPropertyDetails(propertyId);
        };

        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            const toggleBtn = panel.querySelector('.filter-toggle-btn');

            panel.classList.toggle('collapsed');
            toggleBtn.textContent = panel.classList.contains('collapsed') ? '+' : '‚àí';
        }

        function togglePropertyType(btn, type) {
            btn.classList.toggle('active');

            if (btn.classList.contains('active')) {
                if (!activePropertyTypes.includes(type)) {
                    activePropertyTypes.push(type);
                }
            } else {
                activePropertyTypes = activePropertyTypes.filter(t => t !== type);
            }
        }

        function applyFilters() {
            const minPrice = parseInt(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseInt(document.getElementById('maxPrice').value) || Infinity;

            let visibleCount = 0;

            allMarkers.forEach(markerData => {
                const property = markerData.property;
                const marker = markerData.marker;

                const matchesType = activePropertyTypes.includes(property.propertyType);
                const matchesPrice = property.price >= minPrice && property.price <= maxPrice;

                if (matchesType && matchesPrice) {
                    marker.addTo(map);
                    visibleCount++;
                } else {
                    map.removeLayer(marker);
                }
            });

            const resultsDiv = document.getElementById('filterResults');
            if (visibleCount === allMarkers.length) {
                resultsDiv.textContent = `Showing all ${visibleCount} properties`;
            } else {
                resultsDiv.textContent = `Showing ${visibleCount} of ${allMarkers.length} properties`;
            }

            const visibleProperties = allMarkers
                .filter(m => map.hasLayer(m.marker))
                .map(m => m.property);

            if (visibleProperties.length > 0) {
                const bounds = L.latLngBounds(visibleProperties.map(p => [p.lat, p.lng]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            showToast('success', 'Filters Applied', `Showing ${visibleCount} properties`);
        }

        function resetFilters() {
            document.querySelectorAll('.type-filter-btn').forEach(btn => {
                btn.classList.add('active');
            });
            activePropertyTypes = ['Single Family', 'Townhouse', 'Condo'];

            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';

            allMarkers.forEach(markerData => {
                markerData.marker.addTo(map);
            });

            document.getElementById('filterResults').textContent = `Showing all ${allMarkers.length} properties`;
            zoomToAllProperties();

            showToast('info', 'Filters Reset', 'Showing all properties');
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Invalidate map size when switching back to map tab
            if (tabName === 'map') {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }

        }

        // ============================================
        // ADDRESS ANALYSIS FUNCTIONS
        // ============================================

        let currentAnalysisAddress = '';

        function analyzeAddress() {
            const address = document.getElementById('analysisAddress').value.trim();
            if (!address) {
                showToast('error', 'Address Required', 'Please enter an address to analyze');
                return;
            }
            currentAnalysisAddress = address;
            showToast('success', 'Address Set', 'Now select an analysis function below');
        }

        function runAnalysis(type) {
            try {
                const address = document.getElementById('analysisAddress').value.trim();
                if (!address) {
                    showToast('error', 'Address Required', 'Please enter an address first');
                    return;
                }
                currentAnalysisAddress = address;

                showLoading('Running ' + type + ' analysis...');

                // Simulate analysis delay
                setTimeout(() => {
                    hideLoading();
                    displayAnalysisResults(type, address);
                }, 1500);
            } catch (error) {
                console.log('Analysis error:', error);
                hideLoading();
                showToast('error', 'Error', 'Something went wrong. Please try again.');
            }
        }

        function displayAnalysisResults(type, address) {
            try {
                const resultsDiv = document.getElementById('analysisResults');
                const resultsTitle = document.getElementById('resultsTitle');
                const resultsContent = document.getElementById('resultsContent');

                let title = '';
                let content = '';

                switch(type) {
                    case 'commute':
                        title = 'üöó Commute Analysis';
                        content = generateCommuteResults(address);
                        break;
                    case 'fema':
                        title = 'üåä FEMA Flood Records';
                        content = generateFemaResults(address);
                        break;
                    case 'schools':
                        title = 'üéì School Records';
                        content = generateSchoolResults(address);
                        break;
                }

                resultsTitle.innerHTML = title;
                resultsContent.innerHTML = content;
                resultsDiv.classList.add('active');
                resultsDiv.scrollIntoView({ behavior: 'smooth' });

                // Initialize autocomplete for destination address input if commute tab
                if (type === 'commute') {
                    setTimeout(() => {
                        initDestinationAutocomplete();
                    }, 100);
                }
            } catch (error) {
                console.log('Display results error:', error);
                showToast('error', 'Error', 'Failed to display results.');
            }
        }

        function initDestinationAutocomplete() {
            // Destination input is ready for manual entry
        }

        // Saved destinations management
        let savedDestinations = [];
        try {
            const stored = localStorage.getItem('savedDestinations');
            if (stored) {
                savedDestinations = JSON.parse(stored);
            }
        } catch (e) {
            console.log('Error loading saved destinations:', e);
            savedDestinations = [];
        }

        function saveDestinations() {
            localStorage.setItem('savedDestinations', JSON.stringify(savedDestinations));
        }

        function addDestination() {
            const nameInput = document.getElementById('newDestName');
            const addressInput = document.getElementById('newDestAddress');

            const name = nameInput.value.trim();
            const address = addressInput.value.trim();

            if (!name || !address) {
                showToast('error', 'Missing Info', 'Please enter both name and address');
                return;
            }

            const destination = {
                id: Date.now(),
                name: name,
                address: address,
                time: null
            };

            savedDestinations.push(destination);
            saveDestinations();

            nameInput.value = '';
            addressInput.value = '';

            // Refresh the commute results
            const originAddress = document.getElementById('analysisAddress').value.trim();
            if (originAddress) {
                displayAnalysisResults('commute', originAddress);
            }

            showToast('success', 'Destination Added', `${name} has been saved`);
        }

        function removeDestination(id) {
            savedDestinations = savedDestinations.filter(d => d.id !== id);
            saveDestinations();

            // Refresh the commute results
            const originAddress = document.getElementById('analysisAddress').value.trim();
            if (originAddress) {
                displayAnalysisResults('commute', originAddress);
            }

            showToast('info', 'Destination Removed', 'Destination has been deleted');
        }

        var commuteRetries = 0;
        var commuteTimeoutId = null;

        function showCommuteError(message, origin) {
            savedDestinations.forEach(function(dest) {
                var timeElement = document.getElementById('dest-time-' + dest.id);
                if (timeElement) {
                    var mapsUrl = 'https://www.google.com/maps/dir/' + encodeURIComponent(origin) + '/' + encodeURIComponent(dest.address);
                    timeElement.innerHTML = '<span style="color: #dc2626; font-size: 0.8rem;">' + message + '</span> <a href="' + mapsUrl + '" target="_blank" style="color: var(--primary); text-decoration: underline; font-size: 0.75rem; margin-left: 4px;">View in Maps</a>';
                }
            });
        }

        function calculateCommuteTimes(origin) {
            if (savedDestinations.length === 0) return;

            // Clear any previous timeout
            if (commuteTimeoutId) {
                clearTimeout(commuteTimeoutId);
            }

            // Set a timeout to show error if API doesn't respond in 8 seconds
            commuteTimeoutId = setTimeout(function() {
                console.error('Distance Matrix API timeout - no response received');
                showCommuteError('API Timeout', origin);
            }, 8000);

            // Check if Google Maps is available
            if (typeof google === 'undefined' || !google.maps || !google.maps.DistanceMatrixService) {
                commuteRetries++;
                console.log('Waiting for Google Maps API... attempt', commuteRetries);
                if (commuteRetries < 5) {
                    setTimeout(function() { calculateCommuteTimes(origin); }, 1000);
                } else {
                    clearTimeout(commuteTimeoutId);
                    console.error('Google Maps API not available after 5 retries');
                    showCommuteError('API Not Loaded', origin);
                }
                return;
            }

            commuteRetries = 0;
            console.log('Google Maps API loaded, calling Distance Matrix...');
            console.log('Origin:', origin);
            console.log('Destinations:', savedDestinations.map(function(d) { return d.address; }));

            var service = new google.maps.DistanceMatrixService();
            var destinations = savedDestinations.map(function(d) { return d.address; });

            try {
                service.getDistanceMatrix({
                    origins: [origin],
                    destinations: destinations,
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.IMPERIAL
                }, function(response, status) {
                    // Clear the timeout since we got a response
                    clearTimeout(commuteTimeoutId);

                    console.log('Distance Matrix response:', status, response);

                    if (status === 'OK' && response && response.rows && response.rows[0]) {
                        var elements = response.rows[0].elements;
                        for (var i = 0; i < elements.length; i++) {
                            var timeElement = document.getElementById('dest-time-' + savedDestinations[i].id);
                            if (timeElement) {
                                if (elements[i].status === 'OK') {
                                    timeElement.textContent = elements[i].duration.text;
                                    timeElement.style.color = 'var(--primary)';
                                    timeElement.style.fontWeight = '600';
                                } else {
                                    timeElement.textContent = 'No route';
                                    timeElement.style.color = 'var(--text-muted)';
                                }
                            }
                        }
                    } else {
                        console.error('Distance Matrix error:', status);
                        showCommuteError('Error: ' + status, origin);
                    }
                });
            } catch (e) {
                clearTimeout(commuteTimeoutId);
                console.error('Distance Matrix exception:', e);
                showCommuteError('Exception: ' + e.message, origin);
            }
        }

        // Traffic multipliers for typical Tuesday - Going TO destination (morning commute pattern)
        const tuesdayTrafficToDestination = {
            0: 0.7,   // 12 AM - very light
            1: 0.65,  // 1 AM
            2: 0.6,   // 2 AM
            3: 0.6,   // 3 AM
            4: 0.65,  // 4 AM
            5: 0.75,  // 5 AM - early commuters
            6: 0.9,   // 6 AM - building up
            7: 1.3,   // 7 AM - morning rush starts
            8: 1.5,   // 8 AM - peak morning rush
            9: 1.35,  // 9 AM - still busy
            10: 1.0,  // 10 AM - settling down
            11: 0.95, // 11 AM
            12: 1.05, // 12 PM - lunch traffic
            13: 1.0,  // 1 PM
            14: 0.95, // 2 PM
            15: 1.1,  // 3 PM - school pickup
            16: 1.3,  // 4 PM - evening rush starts
            17: 1.55, // 5 PM - peak evening rush
            18: 1.45, // 6 PM - still heavy
            19: 1.2,  // 7 PM - easing
            20: 1.0,  // 8 PM
            21: 0.85, // 9 PM
            22: 0.75, // 10 PM
            23: 0.7   // 11 PM
        };

        // Traffic multipliers for typical Tuesday - Coming FROM destination (evening commute pattern)
        // Reverse pattern: lighter in morning (reverse commute), heavier in evening (going home)
        const tuesdayTrafficFromDestination = {
            0: 0.7,   // 12 AM - very light
            1: 0.65,  // 1 AM
            2: 0.6,   // 2 AM
            3: 0.6,   // 3 AM
            4: 0.65,  // 4 AM
            5: 0.7,   // 5 AM - light reverse commute
            6: 0.8,   // 6 AM - still light going back
            7: 0.9,   // 7 AM - reverse commuters have easier time
            8: 1.0,   // 8 AM - moderate
            9: 0.95,  // 9 AM - settling
            10: 0.9,  // 10 AM
            11: 0.95, // 11 AM
            12: 1.05, // 12 PM - lunch traffic
            13: 1.0,  // 1 PM
            14: 1.0,  // 2 PM
            15: 1.15, // 3 PM - early leavers
            16: 1.4,  // 4 PM - heading home starts
            17: 1.6,  // 5 PM - peak going home
            18: 1.55, // 6 PM - still heavy going home
            19: 1.35, // 7 PM - easing
            20: 1.1,  // 8 PM
            21: 0.9,  // 9 PM
            22: 0.8,  // 10 PM
            23: 0.7   // 11 PM
        };

        var trafficChartTo = null;
        var trafficChartFrom = null;

        function createTrafficChart(canvasId, baseTimeMinutes, multipliers, borderColor, bgColor, existingChart) {
            const hours = [];
            const times = [];
            const colors = [];

            for (let h = 5; h <= 22; h++) { // 5 AM to 10 PM
                hours.push(h < 12 ? h + ' AM' : (h === 12 ? '12 PM' : (h - 12) + ' PM'));
                const adjustedTime = Math.round(baseTimeMinutes * multipliers[h]);
                times.push(adjustedTime);

                // Color based on traffic intensity
                if (multipliers[h] >= 1.4) {
                    colors.push('rgba(220, 38, 38, 0.8)'); // Red for heavy
                } else if (multipliers[h] >= 1.15) {
                    colors.push('rgba(245, 158, 11, 0.8)'); // Orange for moderate
                } else {
                    colors.push('rgba(34, 197, 94, 0.8)'); // Green for light
                }
            }

            const ctx = document.getElementById(canvasId);
            if (!ctx) return null;

            // Destroy existing chart if any
            if (existingChart) {
                existingChart.destroy();
            }

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Commute Time (minutes)',
                        data: times,
                        borderColor: borderColor,
                        backgroundColor: bgColor,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: colors,
                        pointBorderColor: colors,
                        pointRadius: 4,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 13 },
                            bodyFont: { size: 12 },
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    const mins = context.raw;
                                    const hours = Math.floor(mins / 60);
                                    const remainingMins = mins % 60;
                                    if (hours > 0) {
                                        return `${hours}h ${remainingMins}m drive`;
                                    }
                                    return `${mins} min drive`;
                                },
                                afterLabel: function(context) {
                                    const multiplier = multipliers[context.dataIndex + 5];
                                    if (multiplier >= 1.4) return 'üî¥ Heavy traffic';
                                    if (multiplier >= 1.15) return 'üü° Moderate traffic';
                                    return 'üü¢ Light traffic';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Minutes',
                                font: { size: 11, weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time of Day (Tuesday)',
                                font: { size: 11, weight: 'bold' }
                            },
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        function renderTrafficCharts(baseTimeMinutes, destinationName, sourceName) {
            // Render "To Destination" chart
            trafficChartTo = createTrafficChart(
                'trafficChartTo',
                baseTimeMinutes,
                tuesdayTrafficToDestination,
                '#E76F51',
                'rgba(231, 111, 81, 0.1)',
                trafficChartTo
            );

            // Render "From Destination" chart
            trafficChartFrom = createTrafficChart(
                'trafficChartFrom',
                baseTimeMinutes,
                tuesdayTrafficFromDestination,
                '#2A9D8F',
                'rgba(42, 157, 143, 0.1)',
                trafficChartFrom
            );
        }

        var currentAnalysisSource = '';

        function showTrafficAnalysis(destId) {
            const dest = savedDestinations.find(d => d.id === destId);
            if (!dest) return;

            // Get the current time element to extract base time
            const timeElement = document.getElementById('dest-time-' + destId);
            let baseTimeMinutes = 30; // Default 30 min if not calculated

            if (timeElement && timeElement.textContent) {
                const timeText = timeElement.textContent;
                // Parse time like "25 mins" or "1 hour 15 mins"
                const hourMatch = timeText.match(/(\d+)\s*hour/);
                const minMatch = timeText.match(/(\d+)\s*min/);

                let parsedTime = 0;
                if (hourMatch) parsedTime += parseInt(hourMatch[1]) * 60;
                if (minMatch) parsedTime += parseInt(minMatch[1]);

                // Only use parsed time if we found valid numbers
                if (parsedTime > 0) {
                    baseTimeMinutes = parsedTime;
                }

                console.log('Parsed commute time:', timeText, '‚Üí', baseTimeMinutes, 'minutes');
            }

            // Show chart section
            const chartSection = document.getElementById('trafficAnalysisSection');
            if (chartSection) {
                chartSection.style.display = 'block';
                document.getElementById('trafficDestName').textContent = dest.name;
                document.getElementById('trafficSourceName').textContent = currentAnalysisSource || 'Your Address';
                document.getElementById('trafficDestNameReturn').textContent = dest.name;
                document.getElementById('trafficSourceNameReturn').textContent = currentAnalysisSource || 'Your Address';
                renderTrafficCharts(baseTimeMinutes, dest.name, currentAnalysisSource);
            }
        }

        function generateCommuteResults(address) {
            // Store the source address for traffic analysis display
            currentAnalysisSource = address;

            // Calculate times after rendering
            setTimeout(() => calculateCommuteTimes(address), 100);

            const destinationsHTML = savedDestinations.length > 0
                ? savedDestinations.map(dest => `
                    <div class="destination-item">
                        <div class="destination-info">
                            <div class="destination-name">${dest.name}</div>
                            <div class="destination-address">${dest.address}</div>
                        </div>
                        <div class="destination-time" id="dest-time-${dest.id}">Calculating...</div>
                        <button class="btn-chart" onclick="showTrafficAnalysis(${dest.id})" title="View Traffic Analysis" style="background: var(--secondary); color: white; border: none; padding: 0.4rem 0.6rem; border-radius: 6px; cursor: pointer; font-size: 0.75rem; margin-right: 0.5rem;">üìä</button>
                        <button class="destination-delete" onclick="removeDestination(${dest.id})" title="Remove">√ó</button>
                    </div>
                `).join('')
                : '<div class="empty-destinations">No saved destinations yet. Add your frequent places below!</div>';

            return `
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;"><strong>From:</strong> ${address}</p>
                </div>

                <div class="saved-destinations" style="margin-top: 0; padding-top: 0; border-top: none;">
                    <h4>üìç Your Saved Destinations</h4>
                    <div class="destination-list">
                        ${destinationsHTML}
                    </div>

                    <!-- Traffic Analysis Chart Section -->
                    <div id="trafficAnalysisSection" style="display: none; margin-top: 1.5rem; background: var(--bg-white); padding: 1.25rem; border-radius: var(--radius-md); border: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="color: var(--text-primary); margin: 0;">üìä Traffic Analysis</h4>
                            <button onclick="document.getElementById('trafficAnalysisSection').style.display='none'" style="background: none; border: none; font-size: 1.25rem; cursor: pointer; color: var(--text-muted);">√ó</button>
                        </div>
                        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 1.25rem;">Estimated commute times throughout a typical <strong>Tuesday</strong></p>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <!-- To Destination Chart -->
                            <div style="background: var(--bg-light); padding: 1rem; border-radius: var(--radius-md);">
                                <h5 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    üöó Going TO <span id="trafficDestName"></span>
                                </h5>
                                <p style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                                    From: <span id="trafficSourceName"></span>
                                </p>
                                <div style="height: 220px; position: relative;">
                                    <canvas id="trafficChartTo"></canvas>
                                </div>
                            </div>

                            <!-- From Destination Chart -->
                            <div style="background: var(--bg-light); padding: 1rem; border-radius: var(--radius-md);">
                                <h5 style="color: var(--secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    üè† Returning FROM <span id="trafficDestNameReturn"></span>
                                </h5>
                                <p style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                                    To: <span id="trafficSourceNameReturn"></span>
                                </p>
                                <div style="height: 220px; position: relative;">
                                    <canvas id="trafficChartFrom"></canvas>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.25rem; font-size: 0.75rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                            <span><span style="color: #22c55e;">‚óè</span> Light traffic</span>
                            <span><span style="color: #f59e0b;">‚óè</span> Moderate traffic</span>
                            <span><span style="color: #dc2626;">‚óè</span> Heavy traffic</span>
                        </div>

                        <div style="background: rgba(231, 111, 81, 0.1); padding: 0.75rem 1rem; border-radius: var(--radius-sm); margin-top: 1rem; font-size: 0.75rem; color: var(--text-secondary);">
                            <strong>üí° Insight:</strong> Morning rush (7-9 AM) is typically heavier going TO work. Evening rush (5-7 PM) is heavier returning home.
                        </div>
                    </div>

                    <div style="background: var(--bg-light); padding: 1.25rem; border-radius: var(--radius-md); margin-top: 1rem;">
                        <h4 style="font-size: 0.875rem; color: var(--text-primary); margin-bottom: 1rem;">‚ûï Add New Destination</h4>
                        <div class="add-destination-form" style="flex-direction: column;">
                            <input type="text" id="newDestName" placeholder="Name (e.g., Work, Gym, Mom's House)">
                            <input type="text" id="newDestAddress" placeholder="Address (e.g., 123 Main St, Miami, FL)">
                            <button class="btn-add" onclick="addDestination()" style="width: 100%;">+ Add Destination</button>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(42, 157, 143, 0.1); padding: 1rem; border-radius: var(--radius-md); border-left: 4px solid var(--secondary); margin-top: 1.5rem;">
                    <h4 style="color: var(--secondary); margin-bottom: 0.5rem;">üí° Tips</h4>
                    <ul style="margin-left: 1.25rem; color: var(--text-secondary); font-size: 0.875rem;">
                        <li>Click üìä to see traffic patterns throughout the day</li>
                        <li>Times are based on typical Tuesday traffic</li>
                        <li>Peak hours: 7-9 AM and 5-7 PM</li>
                    </ul>
                </div>
            `;
        }

        function generateFemaResults(address) {
            const zones = ['X', 'AE', 'VE', 'A'];
            const randomZone = zones[Math.floor(Math.random() * zones.length)];
            const isHighRisk = randomZone === 'AE' || randomZone === 'VE';

            return `
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;"><strong>Address:</strong> ${address}</p>
                </div>
                <div class="alert ${isHighRisk ? 'alert-warning' : 'alert-success'}" style="margin-bottom: 1.5rem;">
                    <div class="alert-icon">${isHighRisk ? '‚ö†Ô∏è' : '‚úì'}</div>
                    <div class="alert-content">
                        <h4>${isHighRisk ? 'Special Flood Hazard Area' : 'Minimal Flood Risk'}</h4>
                        <p>${isHighRisk ? 'This property is in a high-risk flood zone. Flood insurance is required for federally-backed mortgages.' : 'This property is outside high-risk flood zones. Flood insurance is still recommended.'}</p>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: var(--bg-light); padding: 1rem; border-radius: var(--radius-md);">
                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem;">FEMA Zone</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${randomZone}</div>
                    </div>
                    <div style="background: var(--bg-light); padding: 1rem; border-radius: var(--radius-md);">
                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem;">Base Flood Elevation</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${isHighRisk ? '12 ft' : 'N/A'}</div>
                    </div>
                    <div style="background: var(--bg-light); padding: 1rem; border-radius: var(--radius-md);">
                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem;">Map Panel</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">12086C</div>
                    </div>
                </div>
                <div style="background: var(--bg-light); padding: 1rem; border-radius: var(--radius-md);">
                    <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">Insurance Requirements</h4>
                    <ul style="margin-left: 1.25rem; color: var(--text-secondary); font-size: 0.875rem;">
                        <li>Flood insurance: ${isHighRisk ? 'Required' : 'Recommended'}</li>
                        <li>Estimated annual premium: $${isHighRisk ? '1,200 - $2,500' : '400 - $800'}</li>
                        <li>Elevation certificate: ${isHighRisk ? 'Required for accurate rating' : 'Optional'}</li>
                    </ul>
                </div>
            `;
        }

        function generateSchoolResults(address) {
            return `
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;"><strong>Address:</strong> ${address}</p>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: var(--text-primary); margin-bottom: 1rem;">üìö Nearby Schools</h4>

                    <div style="background: var(--bg-light); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 0.75rem; border-left: 4px solid #10B981;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">Sunrise Elementary</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Public ‚Ä¢ Grades K-5 ‚Ä¢ 0.4 miles</div>
                            </div>
                            <div style="background: #10B981; color: white; padding: 0.25rem 0.75rem; border-radius: 100px; font-weight: 700; font-size: 0.875rem;">8/10</div>
                        </div>
                    </div>

                    <div style="background: var(--bg-light); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 0.75rem; border-left: 4px solid #F59E0B;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">Lincoln Middle School</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Public ‚Ä¢ Grades 6-8 ‚Ä¢ 1.2 miles</div>
                            </div>
                            <div style="background: #F59E0B; color: white; padding: 0.25rem 0.75rem; border-radius: 100px; font-weight: 700; font-size: 0.875rem;">6/10</div>
                        </div>
                    </div>

                    <div style="background: var(--bg-light); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 0.75rem; border-left: 4px solid #10B981;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">Central High School</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Public ‚Ä¢ Grades 9-12 ‚Ä¢ 2.1 miles</div>
                            </div>
                            <div style="background: #10B981; color: white; padding: 0.25rem 0.75rem; border-radius: 100px; font-weight: 700; font-size: 0.875rem;">7/10</div>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(42, 157, 143, 0.1); padding: 1rem; border-radius: var(--radius-md); border-left: 4px solid var(--secondary);">
                    <h4 style="color: var(--secondary); margin-bottom: 0.5rem;">District Information</h4>
                    <p style="font-size: 0.875rem; color: var(--text-secondary);">
                        <strong>District:</strong> Miami-Dade County Public Schools<br>
                        <strong>Total Students:</strong> 350,000+<br>
                        <strong>Student-Teacher Ratio:</strong> 16:1
                    </p>
                </div>
            `;
        }

        function closeResults() {
            document.getElementById('analysisResults').classList.remove('active');
        }

        function showComingSoon() {
            showToast('info', 'Coming Soon', 'This feature is under development');
        }

        // ============================================
        // 5. INITIALIZATION CODE (at the very end)
        // ============================================

        // Initialize address input
        function initAutocomplete() {
            // Address input is ready for manual entry
        }

        // Load saved theme on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            const themeToggle = document.getElementById('themeToggle');

            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
            }

            const savedDataSource = localStorage.getItem('dataSource');
            if (savedDataSource && savedDataSource !== 'demo') {
                updateDataStatus('Connected: ' + savedDataSource);
            }

            // Welcome toast
            setTimeout(() => {
                showToast('info', 'Welcome to PropertyAI', 'Click on any property marker to view detailed analysis', 6000);
            }, 1000);
        });

        // Initialize markers for all properties
        properties.forEach(property => {
            addPropertyMarker(property);
        });

        // Update filter results count
        document.getElementById('filterResults').textContent = `Showing all ${allMarkers.length} properties`;
    </script>
</body>
</html>
